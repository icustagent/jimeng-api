services:
  jimeng-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: jimeng-api
    restart: unless-stopped
    ports:
      - "127.0.0.1:5100:5100"
    environment:
      SERVER_PORT: "5100"
      PLAYWRIGHT_BROWSERS_PATH: "/ms-playwright"
    shm_size: "1gb"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5100/ping"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - jimengapi
      - apinetwork

  jimeng-web-ui:
    build:
      context: .
      dockerfile: deploy/web-ui/Dockerfile
    container_name: jimeng-web-ui
    restart: unless-stopped
    depends_on:
      jimeng-api:
        condition: service_healthy
    networks:
      - jimengapi
      - apinetwork

  jimeng-web-auth:
    build:
      context: .
      dockerfile: deploy/web-auth/Dockerfile
    container_name: jimeng-web-auth
    restart: unless-stopped
    ports:
      - "5173:80"
    environment:
      JIMENG_GUI_USER: "${JIMENG_GUI_USER}"
      JIMENG_GUI_APIKEY: "${JIMENG_GUI_APIKEY}"
    depends_on:
      - jimeng-web-ui
    networks:
      - jimengapi
      - apinetwork

networks:
  jimengapi:
    name: jimengapi
  apinetwork:
    name: apinetwork
